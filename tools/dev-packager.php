<?php
/**
 * Yerel Geli≈ütirme Paket Olu≈üturucu
 * Deƒüi≈üiklik yaptƒ±ƒüƒ±nƒ±zda hƒ±zlƒ±ca paket olu≈üturmak i√ßin
 */

error_reporting(E_ALL);
ini_set('display_errors', 1);

class DevPackager {
    private $version;
    private $description;
    private $packageName;
    private $excludedPaths = [
        'tools/',
        'temp_update_*',
        'backups/',
        'uploads/',
        'vendor/',
        '.git/',
        '.gitignore',
        'README.md',
        'composer.json',
        'composer.lock',
        '*.log',
        '*.backup.*',
        '*.bat',
        '*.zip',
        'config/database.php',  // Config dosyalarƒ±nƒ± koru
        'europagr_teklif.sql',
        'check_db.bat',
        'import_db.bat',
        'test_connection.php'
    ];

    public function __construct() {
        $this->loadCurrentVersion();
    }

    private function loadCurrentVersion() {
        $versionFile = '../version.txt';
        if (file_exists($versionFile)) {
            $this->version = trim(file_get_contents($versionFile));
        } else {
            $this->version = '1.0.0';
        }
    }

    public function incrementVersion($type = 'patch') {
        $parts = explode('.', $this->version);
        $major = (int)($parts[0] ?? 1);
        $minor = (int)($parts[1] ?? 0);
        $patch = (int)($parts[2] ?? 0);

        switch ($type) {
            case 'major':
                $major++;
                $minor = 0;
                $patch = 0;
                break;
            case 'minor':
                $minor++;
                $patch = 0;
                break;
            case 'patch':
            default:
                $patch++;
                break;
        }

        $this->version = "$major.$minor.$patch";

        // version.txt dosyasƒ±nƒ± g√ºncelle
        file_put_contents('../version.txt', $this->version);

        return $this->version;
    }

    public function setDescription($description) {
        $this->description = $description;
    }

    public function createPackage() {
        try {
            $timestamp = time();
            $this->packageName = "update_package_{$this->version}_{$timestamp}";

            echo "üì¶ Paket olu≈üturuluyor: {$this->packageName}\n";
            echo "üî¢ Versiyon: {$this->version}\n";
            echo "üìù A√ßƒ±klama: {$this->description}\n\n";

            // Ge√ßici dizin olu≈ütur
            $packageDir = $this->packageName;
            if (!mkdir($packageDir, 0755, true)) {
                throw new Exception('Paket dizini olu≈üturulamadƒ±');
            }

            // Alt dizinleri olu≈ütur
            mkdir($packageDir . '/files', 0755, true);
            mkdir($packageDir . '/migrations', 0755, true);

            // Dosyalarƒ± kopyala (config hari√ß)
            $this->copyProjectFiles($packageDir . '/files');

            // Son migration dosyalarƒ±nƒ± ekle
            $this->copyRecentMigrations($packageDir . '/migrations');

            // Yapƒ±landƒ±rma dosyasƒ± olu≈ütur
            $this->createConfigFile($packageDir);

            // ZIP olu≈ütur
            $zipFile = $this->createZipFile($packageDir);

            // Ge√ßici dizini temizle
            $this->deleteDirectory($packageDir);

            return [
                'success' => true,
                'file' => $zipFile,
                'version' => $this->version,
                'size' => filesize($zipFile)
            ];

        } catch (Exception $e) {
            if (isset($packageDir) && is_dir($packageDir)) {
                $this->deleteDirectory($packageDir);
            }

            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }

    private function copyProjectFiles($targetDir) {
        $sourceDir = '..';
        $copiedFiles = [];

        echo "üìÅ Proje dosyalarƒ± kopyalanƒ±yor...\n";

        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($sourceDir, RecursiveDirectoryIterator::SKIP_DOTS)
        );

        foreach ($iterator as $file) {
            if ($file->isFile()) {
                $relativePath = str_replace($sourceDir . DIRECTORY_SEPARATOR, '', $file->getPathname());
                $relativePath = str_replace('\\', '/', $relativePath);

                if (!$this->isExcluded($relativePath)) {
                    $targetPath = $targetDir . '/' . $relativePath;
                    $targetDirPath = dirname($targetPath);

                    if (!is_dir($targetDirPath)) {
                        mkdir($targetDirPath, 0755, true);
                    }

                    if (copy($file->getPathname(), $targetPath)) {
                        $copiedFiles[] = $relativePath;
                        echo "  ‚úì {$relativePath}\n";
                    }
                }
            }
        }

        echo "üìä Toplam {" . count($copiedFiles) . "} dosya kopyalandƒ±\n\n";
        return $copiedFiles;
    }

    private function copyRecentMigrations($targetDir) {
        $setupDir = '../setup';
        $migrationFiles = [];

        echo "üîÑ Migration dosyalarƒ± kontrol ediliyor...\n";

        if (is_dir($setupDir)) {
            $files = glob($setupDir . '/*.sql');
            $recentFiles = [];

            foreach ($files as $file) {
                // Son 30 g√ºn i√ßinde deƒüi≈üen migration dosyalarƒ±
                if (filemtime($file) > time() - (30 * 24 * 60 * 60)) {
                    $recentFiles[] = $file;
                }
            }

            foreach ($recentFiles as $file) {
                $filename = basename($file);
                if (copy($file, $targetDir . '/' . $filename)) {
                    $migrationFiles[] = $filename;
                    echo "  ‚úì {$filename}\n";
                }
            }
        }

        if (empty($migrationFiles)) {
            echo "  ‚ÑπÔ∏è  Yeni migration dosyasƒ± bulunamadƒ±\n";
        }

        echo "\n";
        return $migrationFiles;
    }

    private function createConfigFile($packageDir) {
        $config = [
            'version' => $this->version,
            'description' => $this->description,
            'created_at' => date('Y-m-d H:i:s'),
            'created_by' => 'dev-packager',
            'migrations' => $this->getMigrationFiles($packageDir . '/migrations'),
            'files' => $this->getFileList($packageDir . '/files'),
            'config_protection' => true, // Config dosyalarƒ±nƒ± koru
            'excluded_paths' => $this->excludedPaths
        ];

        $configFile = $packageDir . '/update_config.json';
        file_put_contents(
            $configFile,
            json_encode($config, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
        );

        echo "‚öôÔ∏è  Yapƒ±landƒ±rma dosyasƒ± olu≈üturuldu\n";
    }

    private function getMigrationFiles($migrationDir) {
        $migrations = [];
        if (is_dir($migrationDir)) {
            $files = scandir($migrationDir);
            foreach ($files as $file) {
                if (pathinfo($file, PATHINFO_EXTENSION) === 'sql') {
                    $migrations[] = $file;
                }
            }
        }
        return $migrations;
    }

    private function getFileList($filesDir) {
        $files = [];
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($filesDir, RecursiveDirectoryIterator::SKIP_DOTS)
        );

        foreach ($iterator as $file) {
            if ($file->isFile()) {
                $relativePath = str_replace($filesDir . DIRECTORY_SEPARATOR, '', $file->getPathname());
                $relativePath = str_replace('\\', '/', $relativePath);

                $files[] = [
                    'source' => $relativePath,
                    'target' => $relativePath
                ];
            }
        }

        return $files;
    }

    private function createZipFile($packageDir) {
        $zipFile = $this->packageName . '.zip';
        $zip = new ZipArchive();

        if ($zip->open($zipFile, ZipArchive::CREATE) !== TRUE) {
            throw new Exception('ZIP dosyasƒ± olu≈üturulamadƒ±');
        }

        echo "üóúÔ∏è  ZIP dosyasƒ± olu≈üturuluyor...\n";

        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($packageDir, RecursiveDirectoryIterator::SKIP_DOTS)
        );

        foreach ($iterator as $file) {
            if ($file->isFile()) {
                $relativePath = str_replace($packageDir . DIRECTORY_SEPARATOR, '', $file->getPathname());
                $relativePath = str_replace('\\', '/', $relativePath);
                $zip->addFile($file->getPathname(), $relativePath);
            }
        }

        $zip->close();
        echo "  ‚úì {$zipFile} olu≈üturuldu\n\n";

        return $zipFile;
    }

    private function isExcluded($path) {
        foreach ($this->excludedPaths as $excludedPath) {
            if (fnmatch($excludedPath, $path)) {
                return true;
            }
        }
        return false;
    }

    private function deleteDirectory($dir) {
        if (!is_dir($dir)) return;

        $files = array_diff(scandir($dir), array('.', '..'));
        foreach ($files as $file) {
            $path = $dir . '/' . $file;
            if (is_dir($path)) {
                $this->deleteDirectory($path);
            } else {
                unlink($path);
            }
        }
        rmdir($dir);
    }
}

// CLI kullanƒ±mƒ±
if (php_sapi_name() === 'cli') {
    echo "üöÄ Yerel Geli≈ütirme Paket Olu≈üturucu\n";
    echo "=====================================\n\n";

    $packager = new DevPackager();

    // Versiyon t√ºr√ºn√º sor
    echo "Versiyon artƒ±rma t√ºr√º:\n";
    echo "1) Patch (1.0.0 -> 1.0.1) - K√º√ß√ºk d√ºzeltmeler\n";
    echo "2) Minor (1.0.0 -> 1.1.0) - Yeni √∂zellikler\n";
    echo "3) Major (1.0.0 -> 2.0.0) - B√ºy√ºk deƒüi≈üiklikler\n";
    echo "Se√ßiminiz (1-3) [1]: ";

    $choice = trim(fgets(STDIN));
    if (empty($choice)) $choice = '1';

    $versionType = match($choice) {
        '2' => 'minor',
        '3' => 'major',
        default => 'patch'
    };

    // Versiyonu artƒ±r
    $newVersion = $packager->incrementVersion($versionType);
    echo "üî¢ Yeni versiyon: {$newVersion}\n\n";

    // A√ßƒ±klama al
    echo "G√ºncelleme a√ßƒ±klamasƒ±: ";
    $description = trim(fgets(STDIN));
    if (empty($description)) {
        $description = "Versiyon {$newVersion} g√ºncellemesi";
    }

    $packager->setDescription($description);

    // Paketi olu≈ütur
    echo "\nüì¶ Paket olu≈üturuluyor...\n";
    echo "========================\n";

    $result = $packager->createPackage();

    if ($result['success']) {
        echo "‚úÖ Paket ba≈üarƒ±yla olu≈üturuldu!\n\n";
        echo "üìÅ Dosya: {$result['file']}\n";
        echo "üî¢ Versiyon: {$result['version']}\n";
        echo "üìä Boyut: " . number_format($result['size'] / 1024, 2) . " KB\n\n";
        echo "üéØ Bu dosyayƒ± admin panelindeki 'Sistem G√ºncelleme' b√∂l√ºm√ºnden y√ºkleyebilirsiniz.\n";
        echo "üîó URL: http://localhost/erhan/admin/update-manager.php\n";
    } else {
        echo "‚ùå Hata: {$result['error']}\n";
        exit(1);
    }
}

// Web aray√ºz√º i√ßin AJAX endpoint
else if (isset($_POST['action']) && $_POST['action'] === 'create_dev_package') {
    header('Content-Type: application/json');

    $versionType = $_POST['version_type'] ?? 'patch';
    $description = $_POST['description'] ?? '';

    if (empty($description)) {
        echo json_encode(['success' => false, 'error' => 'A√ßƒ±klama gerekli']);
        exit;
    }

    $packager = new DevPackager();
    $newVersion = $packager->incrementVersion($versionType);
    $packager->setDescription($description);

    $result = $packager->createPackage();
    $result['version'] = $newVersion;

    echo json_encode($result);
    exit;
}
?>
